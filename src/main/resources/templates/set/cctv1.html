<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Leaflet.js CCTV 위치</title>

    <!-- Leaflet.js 라이브러리 추가 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!--axios-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js" integrity="sha512-DdX/YwF5e41Ok+AI81HI8f5/5UsoxCVT9GKYZRIzpLxb8Twz4ZwPPX+jQMwMhNQ9b5+zDEefc+dcvQoPWGNZ3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // cctv1List 데이터를 JSON 형식으로 JavaScript에 전달
        var cctvData = [[${cctv1List}]]; // JSON 배열로 변환된 cctv1List
        console.log(cctvData);  // 데이터 확인용 로그 출력
        /*]]>*/
    </script>

</head>
<body>
<h1>Click markers to show details</h1>
<!-- 지도 표시 영역 -->
<div id="map"></div>

<script>
    // 1. 지도 생성 및 초기 설정 (부산을 중심으로 설정)
    var map = L.map('map').setView([35.1796, 129.0756], 13); // 기본 위치: 부산

    // 2. OpenStreetMap 타일 레이어 추가
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // 부산교육청 좌표 (위도, 경도)
    var busanEduLat = 35.1809;
    var busanEduLon = 129.0765;

    // 3. CCTV 위치에 마커 추가 및 팝업 설정 + 드래그앤드롭 기능 추가
    cctvData.forEach(function(cctv) {
        // 위도와 경도가 0.0이면 부산교육청을 기준으로 마커를 표시
        var markerLat = (cctv.lat === 0.0 && cctv.lon === 0.0) ? busanEduLat : cctv.lat;
        var markerLon = (cctv.lat === 0.0 && cctv.lon === 0.0) ? busanEduLon : cctv.lon;

        var marker = L.marker([markerLat, markerLon], { draggable: true }).addTo(map);

        // 마커에 팝업 추가
        marker.bindPopup(`
            <b>Location: ${cctv.instlPos}</b><br>
            <b>Category: ${cctv.category}</b><br>
            <b>Coordinates: ${markerLat}, ${markerLon}</b><br>
        `);

        // 드래그가 끝났을 때 좌표를 업데이트하는 이벤트
        marker.on('dragend', function(event) {
            var newPosition = event.target.getLatLng();
            console.log(`Marker ${cctv.id} moved to: Latitude: ${newPosition.lat}, Longitude: ${newPosition.lng}`);

            // cctvData 배열의 해당 마커 좌표 업데이트
            cctv.lat = newPosition.lat;
            cctv.lon = newPosition.lng;

            console.log('cctvData', cctvData);

            // 새로운 좌표로 팝업 업데이트
            marker.bindPopup(`
                <b>Location: ${cctv.instlPos}</b><br>
                <b>Category: ${cctv.category}</b><br>
                <b>Coordinates: ${cctv.lat}, ${cctv.lon}</b><br>
            `).openPopup();

            // 서버로 좌표 업데이트 요청 전송
            updateCCTVCoordinates(cctv.id, cctv.lat, cctv.lon);
        });
    });

    // 4. 지도 범위 맞춤 (모든 마커를 보기 위해 지도 범위를 설정)
    var markers = cctvData.map(function(cctv) {
        var markerLat = (cctv.lat === 0.0 && cctv.lon === 0.0) ? busanEduLat : cctv.lat;
        var markerLon = (cctv.lat === 0.0 && cctv.lon === 0.0) ? busanEduLon : cctv.lon;
        return [markerLat, markerLon];
    });

    if (markers.length > 0) {
        var bounds = L.latLngBounds(markers);
        map.fitBounds(bounds);
    }

    // 5. 서버로 좌표 업데이트 요청을 보내는 함수 (axios 사용)
    function updateCCTVCoordinates(id, lat, lon) {
        var cctvData = {
            id: id,
            lat: lat,
            lon: lon
        };
        axios.get(`/update/cctv1?id=${id}&lat=${lat}&lon=${lon}`)
            .then(response => {
                console.log('서버 응답:', response.data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

</script>
</body>
</html>
