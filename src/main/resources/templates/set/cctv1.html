<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Kakao Map CCTV 위치</title>

    <!-- Kakao Map API -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0e30a1e6863eb1b5ce29580da9fc4bbb&libraries=services"></script>

    <!-- axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js" integrity="sha512-DdX/YwF5e41Ok+AI81HI8f5/5UsoxCVT9GKYZRIzpLxb8Twz4ZwPPX+jQMwMhNQ9b5+zDEefc+dcvQoPWGNZ3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        .wrapper {

        }

        .controller {
            width: 200px;
            height: 50px;
            position: fixed;
            top: 100px;
            left: 10px;
            right: 0;
            margin: auto;
            background-color: white;
            border-radius: 10px;
            border: 1px solid;
            z-index: 999;
            text-align: center;
            padding: 10px;
            cursor: move;
        }

        #map {
            height: 100vh;
            width: 100%;
        }
    </style>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // cctv1List 데이터를 JSON 형식으로 JavaScript에 전달
        var cctvData = [[${cctv1List}]]; // JSON 배열로 변환된 cctv1List
        console.log(cctvData);  // 데이터 확인용 로그 출력
        /*]]>*/
    </script>
</head>
<body>
<h1>CCTV1(재난CCTV) 마커 편집기</h1>

<div class="wrapper">
    <div class="controller" id="createMarkerButton" draggable="true">
        Create Marker
    </div>

    <div id="map"></div>
</div>

<script>
    // 1. 지도 생성 및 초기 설정 (부산을 중심으로 설정)
    var mapContainer = document.getElementById('map'); // 지도를 표시할 div
    var mapOption = {
        center: new kakao.maps.LatLng(35.1796, 129.0756), // 초기 지도 중심좌표 (부산)
        level: 5 // 초기 지도 확대 레벨
    };

    var map = new kakao.maps.Map(mapContainer, mapOption);

    // 마커 이미지 URL과 크기 지정
    var markerImageUrl = "https://safecity.busan.go.kr/vue/img/gis_picker_cctv_city.a17cfe5e.png"; // 마커 이미지 URL
    var markerImageSize = new kakao.maps.Size(40, 40); // 마커 이미지 크기 (너비 40px, 40px)

    // 마커 이미지 생성
    var markerImage = new kakao.maps.MarkerImage(markerImageUrl, markerImageSize);

    // CCTV 데이터 기반 마커 생성 및 설정
    cctvData.forEach(function(cctv) {
        createCCTVMarker(cctv);
    });

    // 2. CCTV 마커 생성 함수 정의
    function createCCTVMarker(cctv) {
        var markerLat = (cctv.lat === 0.0 && cctv.lon === 0.0) ? busanEduLat : cctv.lat;
        var markerLon = (cctv.lat === 0.0 && cctv.lon === 0.0) ? busanEduLon : cctv.lon;

        var markerPosition = new kakao.maps.LatLng(markerLat, markerLon);

        var marker = new kakao.maps.Marker({
            position: markerPosition,
            map: map,
            image: markerImage,
            draggable: true
        });

        var infoContent = `
            <div style="padding:5px;">
                <b>Location: ${cctv.instlPos}</b><br>
                <b>Category: ${cctv.category}</b><br>
                <b>Coordinates: ${markerLat}, ${markerLon}</b>
            </div>
        `;

        var infowindow = new kakao.maps.InfoWindow({
            content: infoContent
        });

        kakao.maps.event.addListener(marker, 'mouseover', function() {
            infowindow.open(map, marker);
        });

        kakao.maps.event.addListener(marker, 'mouseout', function() {
            infowindow.close();
        });

        kakao.maps.event.addListener(marker, 'dragend', function() {
            var newPosition = marker.getPosition();
            console.log(`Marker ${cctv.id} moved to: Latitude: ${newPosition.getLat()}, Longitude: ${newPosition.getLng()}`);
            cctv.lat = newPosition.getLat();
            cctv.lon = newPosition.getLng();
            updateCCTVCoordinates(cctv.id, cctv.lat, cctv.lon);
        });
    }

    // 3. 서버로 좌표 업데이트 요청을 보내는 함수 (axios 사용)
    function updateCCTVCoordinates(id, lat, lon) {
        axios.get(`/update/cctv1?id=${id}&lat=${lat}&lon=${lon}`)
            .then(response => {
                console.log('서버 응답:', response.data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 4. 새로운 마커 생성 함수
    function createMarkerAtPosition(position) {
        var marker = new kakao.maps.Marker({
            position: position,
            map: map,
            image: markerImage,
            draggable: true
        });

        kakao.maps.event.addListener(marker, 'dragend', function() {
            var newPosition = marker.getPosition();
            console.log(`New Marker moved to: Latitude: ${newPosition.getLat()}, Longitude: ${newPosition.getLng()}`);
        });
    }

    // 5. 드래그 앤 드롭 기능 추가
    var createMarkerButton = document.getElementById('createMarkerButton');

    // 드래그 시작 이벤트
    createMarkerButton.addEventListener('dragstart', function(event) {
        event.dataTransfer.setData('text/plain', 'createMarker');
    });

    // 지도 드래그오버 이벤트 (드래그 가능 설정)
    mapContainer.addEventListener('dragover', function(event) {
        event.preventDefault();
    });

    // 지도 드롭 이벤트
    mapContainer.addEventListener('drop', function(event) {
        event.preventDefault();

        // 드롭한 위치의 지도 좌표 계산
        var mouseX = event.clientX;
        var mouseY = event.clientY;

        var proj = map.getProjection();
        var point = new kakao.maps.Point(mouseX, mouseY);
        var latlng = proj.coordsFromPoint(point);

        // 드롭 위치에 마커 생성
        createMarkerAtPosition(latlng);
    });
</script>
</body>
</html>
